---
title: 'Master data extraction.Rmd'
author: "Jonathan Reardon"
output:
  html_document:
    keep_md: true
    #df_print: paged
  #pdf_document:
    #keep_md: true
editor_options:
  chunk_output_type: inline
---

**Import R libraries, save figures to "Master_figs/"**
```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = T,
                      fig.path = "Master_figs/")
library(reticulate)
library(ggplot2)
library(dplyr)
library(reshape2)
library(purrr)
library(gridExtra)
library(cowplot)
library(kableExtra)
library(forestplot)
library(metafor)
use_python("/usr/local/bin/python3")
rm(list = ls())
```
**Import Python packages and (json) dataset**
```{python}
# import necessary libraries
import json
from collections import Counter
from pprint import pprint
import numpy as np
from matplotlib import pyplot as plt
import pandas as pd
plt.style.use('ggplot')

# import dataset (uncomment to select dataset of choice)
#with open('/home/jon/json/ToolkitExtraction/data/batch2.json') as f:
#with open('/home/jon/json/ToolkitExtraction/data/Batch1.json') as f:
with open('/home/jon/json/ToolkitExtraction/data/May11th_2020.json') as f:
    data=json.load(f)
```
**Flatten dataset into lists containing all attribute names and Ids to easily get top-level (CodeSets) information**
```{python}
def extract_values(obj, key):
    """Pull all values of specified key from nested JSON."""
    arr = []

    def extract(obj, arr, key):
        """Recursively search for values of key in JSON tree."""
        if isinstance(obj, dict):
            for k, v in obj.items():
                if isinstance(v, (dict, list)):
                    extract(v, arr, key)
                elif k == key:
                    arr.append(v)
        elif isinstance(obj, list):
            for item in obj:
                extract(item, arr, key)
        return arr

    results = extract(obj, arr, key)
    return results

x = extract_values(data,'AttributeName')
y = extract_values(data,'AttributeId')

df=[]
for xs, ys in zip(x, y):
    df.append([xs, ys])
```
## CodeSets extraction

These functions extract attribute names and ID's (e.g. strand, educational setting) and return Python dictionaries containing attribute ID's as 'keys' and attribute names as 'values'. The 'Codesets' section at the top of the file does not contain any data, only variable information.

**Example dictionaries**  
strands&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= {5023544: 'Arts participation', 5023545: 'Aspiration interventions', .. }  
edu_setting&nbsp;&nbsp;&nbsp;= {5215410: 'Nursery school/pre-school', 5215411: 'Primary/elementary school', 5215412, .. }

```{python}
# STRAND
def get_strand_info():
    strands={}
    for counter, item in enumerate(df):
        if item[0] == "Toolkit strand(s) (select at least one Toolkit strand)":
            for i in range(1,34):
                strands.update( {df[counter+i][1]:df[counter+i][0]} )
    return strands
strand_codes = get_strand_info()

# STUDY DESIGN
def get_study_design_info():
    study_design={}
    for counter, item in enumerate(df):
        if item[0] == "What was the study design?":
            for i in range(1,10):
                study_design.update( {df[counter+i][1]:df[counter+i][0]} )
    return study_design
study_design = get_study_design_info()

# EDUCATIONAL SETTING
def get_edu_setting_info():
    edu_setting={}
    for counter, item in enumerate(df):
        if item[0] == "What is the educational setting (Select ALL that apply)":
            for i in range(1,12):
                edu_setting.update( {df[counter+i][1]:df[counter+i][0]} )   
    return edu_setting
edu_setting = get_edu_setting_info()

# COUNTRIES
def get_countries_info():
    countries={}
    for counter, item in enumerate(df):
        if item[0] == "In which country/countries was the study carried out? (Select ALL that apply)":
            for i in range(1,188):
                countries.update( {df[counter+i][1]:df[counter+i][0]} ) 
    return countries
countries = get_countries_info()

for k,v in countries.items():
    print(k,v)
```

```{python}

def get_strands():
  exclude="-"
  finds=[]
    
  section_count=0
  codes_section_count=0
  outcomes_section_count=0
  outcome_codes_section=0
  # iterate over each section within each study of 'references'
  for section in range(len(data["References"])):
      if "Codes" in data["References"][section]:
          if "Outcomes" in data["References"][section]:
              if "OutcomeCodes" in data["References"][section]["Outcomes"][0]:
                  for study in range(len(data["References"][section]["Outcomes"][0]["OutcomeCodes"]["OutcomeItemAttributesList"])):
                      for key,value in strand_codes.items():
                          if key == data["References"][section]["Outcomes"][0]["OutcomeCodes"]["OutcomeItemAttributesList"][study]["AttributeId"]:
                              strandfind=value
                              strandlabel=key
                  finds.append([strandfind, strandlabel])
              else:
                  finds.append([exclude])
          else:
              finds.append([exclude])
      else:
          finds.append([exclude])
        
    
  return finds

strand_info = get_strands() 

new=[]
for obj in strand_info:
    new.append(obj[0])
    
peer_tut_count = new.count("Toolkit: Peer Tutoring")
feedback_count = new.count("Toolkit: Feedback")
summer_schools_count = new.count("Toolkit: Summer schools")
extending_school_time_count = new.count("Toolkit: Extending school time")
ta_count = new.count("Toolkit: Teaching assistants")
sgt_count = new.count("Toolkit: Small Group Tuition")
one_to_one_count = new.count("Toolkit: One to one tuition")
parental_eng = new.count("Toolkit: Parental engagement")
nan = new.count("-")

print("peer tut count:", peer_tut_count) #110
print("feedback count:", feedback_count) #116
print("summer schools count:", summer_schools_count) #52
print("extending school time count:", extending_school_time_count) #73
print("ta count:", ta_count) # 62
print("sgt count:", sgt_count) # 31
print("one to one count:", one_to_one_count) # none
print("parental eng count:", parental_eng) # none
print("nan:", nan)
```

```{python}
exclude="-"
studydesign=[]
for section in range(len(data["References"])):
    if "Codes" in data["References"][section]:
        for study in range(len(data["References"][section]["Codes"])):
            for key, value in study_design.items():
                if key == data["References"][section]["Codes"][study]["AttributeId"]:
                    studydesignfind=value
                    studydesignlabel=key
        studydesign.append([studydesignfind])
    else:
        studydesign.append([exclude])

exclude="-"
edusetting=[]
for section in range(len(data["References"])):
    if "Codes" in data["References"][section]:
        for study in range(len(data["References"][section]["Codes"])):
            for key,value in edu_setting.items():
                if key == data["References"][section]["Codes"][study]["AttributeId"]:
                    edusettingfind=value
                    edusettingvalue=key
        edusetting.append([edusettingfind])
    else:
        edusetting.append([exclude])

exclude="-"
country=[]
for section in range(len(data["References"])):
    if "Codes" in data["References"][section]:
        for study in range(len(data["References"][section]["Codes"])):
            for key,value in countries.items():
                if key == data["References"][section]["Codes"][study]["AttributeId"]:
                    countryfind=value
                    countryvalue=key
        country.append([countryfind])
    else:
        country.append([exclude])
pprint(len(country))


```

```{python}
titles=[]
for section in range(len(data["References"])):
    if "ShortTitle" in data["References"][section]:
        titles.append(data["References"][section]["ShortTitle"])
print(len(titles))
```

```{python}
exclude="-"
year=[]
for section in range(len(data["References"])):
    if "Year" in data["References"][section]:
        year.append(int(data["References"][section]["Year"]))
    else:
        year.append(exclude)
pprint(len(year))
```

```{python}

codes_check=[]
outcomes_check=[]
outcomecodes_check=[]

for section in range(len(data["References"])):
    Codes="No"
    Outcomes="No"
    OutcomeCodes="No"
    if "Codes" in data["References"][section]:
        Codes="Yes"
        if "Outcomes" in data["References"][section]:
            Outcomes="Yes"
            if "OutcomeCodes" in data["References"][section]["Outcomes"][0]:
                OutcomeCodes="Yes"
          
    codes_check.append(Codes)
    outcomes_check.append(Outcomes)
    outcomecodes_check.append(OutcomeCodes)
```

```{python}
itemids=[]
exclude="-"
for section in range(len(data["References"])):
  if "ItemId" in  data["References"][section]:
      itemids.append(data["References"][section]["ItemId"])
  else:
      itemid=exclude
print(len(itemids))

```

```{python}
exclude="-"
outcometext=[]
interventiontext=[]
SMD=[]
SESMD=[]
CIupperSMD=[]
CIlowerSMD=[]
for section in range(len(data["References"])):
  if "ItemId" in  data["References"][section]:
      if "Outcomes" in data["References"][section]:
          outcometext.append(data["References"][section]["Outcomes"][0]["OutcomeText"])
          interventiontext.append(data["References"][section]["Outcomes"][0]["InterventionText"])
          SMD.append(data["References"][section]["Outcomes"][0]["SMD"])
          SESMD.append(data["References"][section]["Outcomes"][0]["SESMD"])
          CIupperSMD.append(data["References"][section]["Outcomes"][0]["CIUpperSMD"])
          CIlowerSMD.append(data["References"][section]["Outcomes"][0]["CILowerSMD"])
                  
      else:
          outcometext.append(exclude)
          interventiontext.append(exclude)
          SMD.append(exclude)
          SESMD.append(exclude)
          CIupperSMD.append(exclude)
          CIlowerSMD.append(exclude)
  else:
      outcometext.append(exclude)
      interventiontext.append(exclude)
      SMD.append(exclude)
      SESMD.append(exclude)
      CIupperSMD.append(exclude)
      CIlowerSMD.append(exclude)
      
print(len(outcometext))
print(len(interventiontext))
print(len(SMD))
print(len(SESMD))
print(len(CIupperSMD))
print(len(CIlowerSMD))

```

```{python}

df = pd.DataFrame(list(zip(itemids, titles, year, new, country, studydesign, edusetting, outcometext, interventiontext,
                           SMD, SESMD, CIupperSMD, CIlowerSMD, codes_check, outcomes_check, outcomecodes_check)), 
               columns =['Item Id', 'Author', 'Year', 'Strand', 'Country', 'Study Design', 'Educational Setting', 'Outcome', 'Intervention', 
                        'SMD', 'SESMD', 'CIupperSMD', 'CIlowerSMD', 'Codes section present', 'Outcomes section present', 'OutcomeCodes section present']) 
df
```

```{r}

# display all studies (primary and secondary for error checking etc.)
all <- data.frame(py$df)
View(all)

#write.csv(all, "May11th_2020_summary_withItemIds.csv", row.names=FALSE)
```