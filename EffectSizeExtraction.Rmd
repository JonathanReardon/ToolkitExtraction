---
title: "Effect Size Extraction"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup}
library(reticulate)
library(ggplot2)
library(dplyr)
library(gridExtra)
use_python("/usr/local/bin/python3")
```


```{python}
# import necessary packages
import json
from pprint import pprint
import pandas as pd

# control row/column display amount
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', 10)

# open our json file
with open('/home/jon/json/Batch1.json') as f:
    data=json.load(f)

def get_study_outcomes(outcome_choice):
    '''
    A function that takes in your outcome of choice
    "primary/secondary" etc. and returns a list
    of the relevant effect size information
    '''
    global no_outcome
    outcome_studies=[]
    no_outcome=0
    for counter, item in enumerate(data["References"]):
        if "Outcomes" in data["References"][counter]:
            if data["References"][counter]["Outcomes"][0]["OutcomeText"] == outcome_choice:
                outcome_id=((data["References"][counter]["Outcomes"][0]["OutcomeId"]))
                yes_outcome=(data["References"][counter]["Outcomes"][0]["ShortTitle"])
                outcome_text=(data["References"][counter]["Outcomes"][0]["OutcomeText"])
                SMD=(data["References"][counter]["Outcomes"][0]["SMD"])
                SESMD=(data["References"][counter]["Outcomes"][0]["SESMD"])
                year=(data["References"][counter]["Year"])
                intervention=(data["References"][counter]["Outcomes"][0]["InterventionText"])
                outcome_studies.append([outcome_id, yes_outcome, outcome_text, year, intervention, SMD, SESMD])
        else:
            no_outcome+=1
    return outcome_studies

# function calls
primary = get_study_outcomes("Primary outcome")
secondary = get_study_outcomes("Secondary outcome(s)")
        
# make pandas dataframe with our lists
df_primary = pd.DataFrame(primary, columns=['OutcomeId', 'ShortTitle', 'OutcomeText', 'Year', 'Intervention', 'SMD', 'SESMD'])
df_secondary = pd.DataFrame(secondary, columns=['OutcomeId', 'ShortTitle', 'OutcomeText', 'Year', 'Intervention', 'SMD', 'SESMD'])

# round effect sizes to two decimal points
df_primary.loc[:, "SMD"] = df_primary["SMD"].astype(float).round(2)
df_primary.loc[:, "SESMD"] = df_primary["SESMD"].astype(float).round(2)

# round effect sizes to two decimal points
df_secondary.loc[:, "SMD"] = df_secondary["SMD"].astype(float).round(2)
df_secondary.loc[:, "SESMD"] = df_secondary["SESMD"].astype(float).round(2)

# sort "Year" values ascending (for plotting)
#df_primary.sort_values("Year", axis=0, ascending=True, inplace=True, kind='quicksort')
#df_secondary.sort_values("Year", axis=0, ascending=True, inplace=True, kind='quicksort')

#df.plot(x="Year", y="SMD", kind='line')
#export_csv = df.to_csv(r'/home/jon/json/outcome_measures.csv', index=False)
print("Number of Primary Outcome studies:", len(df_primary))
print(df_primary.head(15))
print("Number of Secondary Outcome studies:", len(df_secondary))
print(df_secondary.head(15))

#print(df_primary["Intervention"])
```


```{r}
primary_df <- data.frame(py$df_primary)
secondary_df <- data.frame(py$df_secondary)

primary_df$Intervention <- as.character(primary_df$Intervention)
primary_df$Intervention[primary_df$Intervention==""] <- "NA"
primary_df$Intervention <- as.factor(primary_df$Intervention)

primary_mean_SMD <- mean(primary_df$SMD, na.rm=TRUE)
secondary_mean_SMD <- mean(secondary_df$SMD, na.rm=TRUE)

primary_mean_SESMD <- mean(primary_df$SESMD, na.rm=TRUE)
secondary_mean_SESMD <- mean(secondary_df$SESMD, na.rm=TRUE)

primary_mean_SMD
secondary_mean_SMD

primary_mean_SESMD
secondary_mean_SESMD
```
```{r, fig.width=10,fig.height=5}
ggplot(data=primary_df, aes(SMD, SESMD)) + geom_point(alpha=.5, na.rm=TRUE, color="Black") +
    theme_grey() +
    geom_vline(xintercept=primary_mean_SMD, linetype="dotted", color="red", size=1) +
    theme(legend.title = element_text(color = "blue", size = 5),
          legend.text = element_text(color = "red", size = 5)) +
    annotate(geom="text", x=primary_mean_SMD+.15, y=-.1, label=round(primary_mean_SMD, 2), color="red")


```{r, fig.width=11,fig.height=5}
ggplot(data=primary_df, aes(SMD, SESMD, color=Intervention)) + geom_point(alpha=1, na.rm=TRUE) +
    theme_grey() +
    geom_vline(xintercept=primary_mean_SMD, linetype="dotted", color="black", size=1) +
    theme(legend.title = element_text(color = "black", size = 10),
          legend.text = element_text(color = "black", size = 8)) +
    theme(legend.position="right") +
    guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
    theme(legend.title=element_blank())
```

```{r}
ggplot(data=py$df_secondary, aes(SMD, SESMD)) + geom_point() +
    theme_grey() +
    geom_vline(xintercept=secondary_mean_SMD, linetype="dotted", color="red", size=1, na.rm=TRUE) +
    geom_hline(yintercept=secondary_mean_SESMD, linetype="dotted", color="red", size=1)
```

```{r, fig.width=11,fig.height=5}
ggplot(data=primary_df, aes(Year, SESMD, color=Intervention)) + geom_point(na.rm=TRUE) +
    theme_grey() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylim(-0.25, 2.5)
```

```{r, fig.width=9,fig.height=7}

primary_df %>%
  filter(Intervention=="Mathematics" | Intervention=="Literacy: reading comprehension") %>% 
  ggplot(., aes(SMD, SESMD, color=Intervention)) + geom_point(alpha=1, na.rm=TRUE) -> p1

primary_df %>%
  filter(Intervention=="Science" | Intervention=="Literacy: reading comprehension") %>% 
  ggplot(., aes(SMD, SESMD, color=Intervention)) + geom_point(alpha=1, na.rm=TRUE) -> p2

grid.arrange(p1, p2, ncol=1)
```

